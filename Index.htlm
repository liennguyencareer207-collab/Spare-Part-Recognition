<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teachable Machine JSON Bridge</title>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

  <!-- Teachable Machine Image -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
    }
  </style>
</head>

<body>
  <h3>Teachable Machine Prediction</h3>

  <input type="file" id="imageInput" accept="image/*">
  <br><br>
  <button onclick="predict()">Predict</button>

  <pre id="output"></pre>

  <script>
    // ===== MODEL URL =====
    const modelURL = "https://teachablemachine.withgoogle.com/models/DDSVpYbTr/";
    let model;

    async function loadModel() {
      model = await tmImage.load(
        modelURL + "model.json",
        modelURL + "metadata.json"
      );
      console.log("Model loaded");
    }

    loadModel();

    async function predict() {
      const input = document.getElementById("imageInput");
      if (input.files.length === 0) {
        alert("Please select an image");
        return;
      }

      const img = document.createElement("img");
      img.src = URL.createObjectURL(input.files[0]);
      await img.decode();

      const predictions = await model.predict(img);

      // Lấy class có confidence cao nhất
      let best = predictions[0];
      for (let i = 1; i < predictions.length; i++) {
        if (predictions[i].probability > best.probability) {
          best = predictions[i];
        }
      }

      // ===== JSON OUTPUT =====
      const result = {
        label: best.className,
        confidence: Number(best.probability.toFixed(4))
      };

      // Hiển thị JSON trên web (để test)
      document.getElementById("output").textContent =
        JSON.stringify(result, null, 2);

      // Gửi JSON về Thunkable
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(
          JSON.stringify(result)
        );
      }
    }
  </script>
</body>
</html>
